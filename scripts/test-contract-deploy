#!/usr/bin/env bash

set -emuo pipefail

cleanup() {
    trap - EXIT TERM
    if [ -n "$ANVIL_PID" ]; then
        kill "$ANVIL_PID" 2>/dev/null || true
    fi
    rm -f .anvil.pid anvil.log
}

trap cleanup EXIT TERM INT

# Kill any existing anvil processes to avoid port conflicts
pkill anvil || true
sleep 1

# Start anvil in background
anvil --port 8545 >anvil.log 2>&1 &
ANVIL_PID=$!
echo $ANVIL_PID >.anvil.pid

# Wait for anvil to start
sleep 1

# Run the deploy command
MANAGER_MNEMONIC="test test test test test test test test test test test junk"
MANAGER_ACCOUNT_INDEX=0
URL="http://localhost:8545"
RUST_LOG=info cargo run --bin deploy -- -m "$MANAGER_MNEMONIC" -i "$MANAGER_ACCOUNT_INDEX" -u "$URL"
