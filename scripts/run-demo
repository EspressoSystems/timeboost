#!/bin/bash

set -euox pipefail

if ! command -v uv &> /dev/null; then
  echo "Error: uv command not found. Install it with 'curl -LsSf https://astral.sh/uv/install.sh | sh'" >&2
  exit 1
fi

just build_release --features until

if [ -z "${1:-}" ]; then
    nodes=5
else
    if ! [[ $1 =~ ^[4-9]+$ ]]; then
        echo "Error: The number of nodes must be a positive integer greater than 4."
        exit 1
    fi
    nodes=$1
fi

curl -LsSf https://raw.githubusercontent.com/OffchainLabs/nitro-devnode/main/run-dev-node.sh | sudo bash || true
timeout 5 bash -c 'until curl -sSf http://localhost:8547 -o /dev/null; do sleep 1; done'

uv run fake-contract/main.py "$nodes" --timeout 30 &

late_start=false

if [ "${2:-}" = "true" ]; then
    late_start=true
fi
pids=()
SECONDS=0
for i in $(seq 0 $((nodes - 1))); do
    echo "Starting node $i"

  cmd="RUST_LOG=timeboost=info,sailfish=info,timeboost_networking=warn \
    ./target/release/timeboost \
        --id $i \
        --port $((8000 + $i)) \
        --rpc-port $((8800 + $i)) \
        --metrics-port $((9000 + $i)) \
        --until 300 \
        --watchdog-timeout 300"
    if $late_start; then
        cmd="$cmd --late-start --late-start-node-id 0"
    fi

    eval $cmd &
    pids+=($!)
done

for pid in "${pids[@]}"; do
    wait $pid
    exit_code=$?

    if [ $exit_code -eq 0 ]; then
        echo "Process $pid completed successfully with exit code $exit_code."
    else
        echo "Process $pid failed with exit code $exit_code."
    fi
done
sudo pkill -9 nitro

duration=$SECONDS
echo "All processes have finished (duration: $((duration)) sec)."
